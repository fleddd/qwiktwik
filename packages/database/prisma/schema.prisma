generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum Plan {
  FREE
  PRO
}

enum BillingInterval {
  MONTHLY
  YEARLY
  LIFETIME
  NONE
}

enum SubStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELED
}

enum TxStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String?
  name         String?
  avatar       String?
  role         Role    @default(USER)

  subscription  Subscription?
  transactions  Transaction[]
  oauthAccounts OAuthAccount[]
  devices       Device[] // Зв'язок з ПК користувача (HWID)

  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?
  passwordChangedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OAuthAccount {
  id                String @id @default(uuid())
  userId            String
  provider          String
  providerAccountId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Subscription {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan     Plan            @default(FREE)
  status   SubStatus       @default(INACTIVE)
  interval BillingInterval @default(NONE)

  paymentProvider        String? // 'stripe', 'coinbase', 'nowpayments'
  providerCustomerId     String?
  providerSubscriptionId String?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount   Float
  currency String // 'USD', 'USDT', 'BTC'

  provider     String // 'stripe', 'crypto'
  providerTxId String? @unique

  status       TxStatus        @default(PENDING)
  intervalPaid BillingInterval

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// НОВА МОДЕЛЬ: Пристрої (для прив'язки HWID)
model Device {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  hwid     String // Унікальний ідентифікатор заліза від С++ клієнта
  name     String? // Опціонально: назва ПК (напр. "DESKTOP-X99")
  lastSeen DateTime @default(now())

  createdAt DateTime @default(now())

  @@unique([userId, hwid])
}

// НОВА МОДЕЛЬ: Релізи (Версії десктопної програми)
model Release {
  id          String  @id @default(uuid())
  version     String  @unique // Наприклад: "1.0.0"
  downloadUrl String // Посилання на .exe файл
  changelog   String? @db.Text // Що нового в цій версії

  isActive Boolean @default(true) // Чи показувати на сайті/в програмі

  createdAt DateTime @default(now())
}
